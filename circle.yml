machine:
  node:
    version: 6
  environment:
    _JAVA_OPTIONS: "-XX:MaxHeapSize=2g"
    PATH: $HOME/.cache/bin/:$HOME/.cache/venv/bin:$PATH
    COMMIT: "$(cut -c1-6 <<< $CIRCLE_SHA1)"
    CASSANDRA_STARTUP_TIMEOUT: 120

  java:
    version: oraclejdk8

dependencies:
  cache_directories:
    - "~/.cache"
    - "~/.sbt"
    - "backend/target/resolution-cache"
    - "backend/target/streams"
    - "backend/project/target/resolution-cache"
    - "backend/project/target/streams"
    - "frontend/node_modules"

test:
  pre:
    - (cd frontend; npm install)
    - (cd frontend; npm run buildTest)
    - (cd backend; sbt test:compile)
  override:
    - (cd frontend; npm run lint)
    - (cd frontend; npm test)
    - (cd backend; sbt test)
    - (cd backend; sbt cucumber)
  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - find . \( \! -readable -prune \) -o \( -type f -regex ".*/target/test-reports/.*xml" \) -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;

deployment:
  production:
    branch: production
    heroku:
      appname: originate-play-template
